#!/bin/bash

# Propio Integration Fix Script
# Run this from the Laravel app directory: E:\Proprio-Link\webapp\laravel-react-app

echo "ğŸ”§ Starting Propio Integration Fix..."

# Step 1: Check if Laravel server is running
echo "ğŸ“¡ Step 1: Checking Laravel server status..."
php artisan route:list | grep -i wordpress > /dev/null
if [ $? -eq 0 ]; then
    echo "âœ… Laravel routes found"
else
    echo "âŒ Laravel routes not found - starting server..."
    echo "Please run: php artisan serve"
fi

# Step 2: Check database connection
echo "ğŸ“Š Step 2: Checking database connection..."
php artisan tinker --execute="try { DB::connection()->getPdo(); echo 'Database connected'; } catch(Exception \$e) { echo 'Database error: ' . \$e->getMessage(); }"

# Step 3: Run migrations
echo "ğŸ—ƒï¸ Step 3: Running database migrations..."
php artisan migrate --force

# Step 4: Check if properties exist
echo "ğŸ  Step 4: Checking for existing properties..."
PROPERTY_COUNT=$(php artisan tinker --execute="echo App\Models\Property::count();")
echo "Found $PROPERTY_COUNT properties"

if [ "$PROPERTY_COUNT" -eq "0" ]; then
    echo "ğŸ“¥ No properties found, running seeder..."
    php artisan db:seed --class=PropertySeeder --force
    echo "âœ… Test properties created"
fi

# Step 5: Clear caches
echo "ğŸ§¹ Step 5: Clearing caches..."
php artisan cache:clear
php artisan config:clear
php artisan route:clear

# Step 6: Test API endpoints
echo "ğŸŒ Step 6: Testing API endpoints..."
echo "Testing WordPress API..."
curl -s "http://localhost:8000/api/wordpress/property-types" | head -100

echo ""
echo "ğŸ‰ Fix script completed!"
echo "ğŸ’¡ Next steps:"
echo "1. Access debug page: http://localhost/wordpress-2/wp-content/plugins/propio-integration/debug-comprehensive.php?debug=propio"
echo "2. Check WordPress plugin is active in WP Admin"
echo "3. Configure plugin settings in WordPress Admin â†’ Settings â†’ Propio Integration"
